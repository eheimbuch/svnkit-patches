# HG changeset patch
# Parent 924be003144ca7e59493e3d97d4860fa8dab5c0a
fix error 500 path not found for urls with non url characters

diff -r 924be003144c -r cc86febe5f15 svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/DAVRepositoryManager.java
--- a/svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/DAVRepositoryManager.java	Fri May 04 08:20:31 2012 +0200
+++ b/svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/DAVRepositoryManager.java	Fri May 04 08:29:38 2012 +0200
@@ -64,7 +64,7 @@
         myUserPrincipal = request.getUserPrincipal();
         myRepositoryRootDir = getRepositoryRootDir(request.getPathInfo());
         myResourcePathInfo = getResourcePathInfo(request);
-            
+        
         if (config.isUsingPBA()) {
             String path = null;
             if (!DAVHandlerFactory.METHOD_MERGE.equals(request.getMethod())) {
@@ -182,6 +182,7 @@
         String uri = DAVPathUtil.addLeadingSlash(url.getURIEncodedPath());
         if (uri.startsWith(getResourceContext())) {
             uri = uri.substring(getResourceContext().length());
+            uri = DAVPathUtil.addLeadingSlash(uri);
         } else {
             SVNErrorManager.error(SVNErrorMessage.create(SVNErrorCode.RA_DAV_REQUEST_FAILED, "Invalid URL ''{0}'' requested", url.toString()), 
                     SVNLogType.NETWORK);
@@ -259,6 +260,8 @@
         String pathInfo = request.getPathInfo();
         if (pathInfo == null || "".equals(pathInfo)) {
             pathInfo = "/";
+        } else {
+          pathInfo = SVNEncodingUtil.uriDecode(pathInfo);
         }
         
         if (getDAVConfig().isUsingRepositoryPathDirective()) {
@@ -291,7 +294,7 @@
                 }
                 requestContext = SVNPathUtil.append(requestContext, servletPath);
             }
-            return SVNEncodingUtil.uriEncode(requestContext);
+            return encodeRequestContext(requestContext);
         }
         
         String reposName = DAVPathUtil.head(pathInfo);
@@ -301,9 +304,13 @@
             }
             String pathToRepos = SVNPathUtil.append(requestContext, servletPath);
             requestContext = SVNPathUtil.append(pathToRepos, reposName);
-            return SVNEncodingUtil.uriEncode(requestContext);
+            return encodeRequestContext(requestContext);
         }
         requestContext = DAVPathUtil.append(requestContext, reposName);
-        return SVNEncodingUtil.uriEncode(requestContext);
+        return encodeRequestContext(requestContext);
+    }
+
+    private String encodeRequestContext(String requestContext){
+      return SVNEncodingUtil.uriEncode( DAVPathUtil.addLeadingSlash(requestContext) );
     }
 }
diff -r 924be003144c -r cc86febe5f15 svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/handlers/DAVResponse.java
--- a/svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/handlers/DAVResponse.java	Fri May 04 08:20:31 2012 +0200
+++ b/svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/handlers/DAVResponse.java	Fri May 04 08:29:38 2012 +0200
@@ -11,6 +11,7 @@
  */
 package org.tmatesoft.svn.core.internal.server.dav.handlers;
 
+import org.tmatesoft.svn.core.internal.util.SVNEncodingUtil;
 
 /**
  * @version 1.1.2
@@ -25,7 +26,8 @@
     
     public DAVResponse(String description, String href, DAVResponse nextResponse, DAVPropsResult propResult, int statusCode) {
         myDescription = description;
-        myHref = href;
+        // encode href to fix scm-manager issue #22
+        myHref = SVNEncodingUtil.uriEncode(href);
         myNextResponse = nextResponse;
         myStatusCode = statusCode;
         myPropResult = propResult;
