# HG changeset patch
# Parent 1338dd1e9a809b9dda43cd228ac5c9f310d533fb

diff -r 1338dd1e9a80 svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/handlers/DAVLogHandler.java
--- a/svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/handlers/DAVLogHandler.java	Mon Jul 23 08:47:52 2012 +0200
+++ b/svnkit-dav/src/main/java/org/tmatesoft/svn/core/internal/server/dav/handlers/DAVLogHandler.java	Mon Jul 23 08:51:05 2012 +0200
@@ -117,7 +117,7 @@
             } else if (SVNRevisionProperty.DATE.equals(propName)) {
                 SVNXMLUtil.openCDataTag(SVNXMLUtil.SVN_NAMESPACE_PREFIX, "date", propValue, null, false, true, xmlBuffer);
             } else if (SVNRevisionProperty.LOG.equals(propName)) {
-                String comment = SVNEncodingUtil.fuzzyEscape(propValue);
+                String comment = SVNEncodingUtil.fuzzyCharEscape(propValue);
                 SVNXMLUtil.openCDataTag(SVNXMLUtil.DAV_NAMESPACE_PREFIX, DAVElement.COMMENT.getName(), comment, null, false, true, xmlBuffer);
             } else {
                 noCustomProperties = false;
diff -r 1338dd1e9a80 svnkit/src/main/java/org/tmatesoft/svn/core/internal/util/SVNEncodingUtil.java
--- a/svnkit/src/main/java/org/tmatesoft/svn/core/internal/util/SVNEncodingUtil.java	Mon Jul 23 08:47:52 2012 +0200
+++ b/svnkit/src/main/java/org/tmatesoft/svn/core/internal/util/SVNEncodingUtil.java	Mon Jul 23 08:51:05 2012 +0200
@@ -334,6 +334,25 @@
         }
         return result.toString();
     }
+    
+   public static String fuzzyCharEscape(String str) {
+        char[] chars = str.toCharArray();
+        StringBuffer result = createStringBuffer(str, 0);
+        for (int i = 0; i < chars.length; i++) {
+            if (!isASCIIControlChar(chars[i]) || chars[i] == '\r' 
+                || chars[i] == '\n' || chars[i] == '\t') {
+                result.append( chars[i]);
+            } else {
+                result.append("?\\");
+                int code = chars[i] & 0xFF;
+                if (code < 100) {
+                    result.append('0');
+                }
+                result.append(code);
+            }
+        }
+        return result.toString();
+    }
 
     public static boolean isHexDigit(char ch) {
         return Character.isDigit(ch) ||
